---
alwaysApply: true
description: 책 구조 분석 모듈 규칙 (Footer 기반 휴리스틱)
---

# Backend 구조 분석 규칙

## Overview

PDF 파싱 결과를 바탕으로 책의 구조(본문 시작, 챕터 경계)를 자동으로 파악하는 모듈입니다. **Footer 기반 휴리스틱만 사용**하며, LLM 보정은 제외합니다.

## StructureBuilder (휴리스틱)

### 파이프라인

```python
# backend/structure/structure_builder.py
def build_structure(self, parsed_data: Dict[str, Any]) -> Dict[str, Any]:
    # 1. 영역 경계 탐지 (서문/본문/끝)
    boundaries = self.boundary_detector.detect_boundaries(parsed_data)
    
    # 2. 챕터 탐지 (본문 영역에서)
    main_pages = boundaries["main"]["pages"]
    chapters = self.chapter_detector.detect_chapters(parsed_data, main_pages)
    
    # 3. 최종 구조 생성
    structure = {
        "start": {"pages": [...], "page_count": N},
        "main": {"pages": [...], "page_count": N, "chapters": [...]},
        "end": {"pages": [...], "page_count": N}
    }
    return structure
```

### ContentBoundaryDetector

**핵심 원칙**: Footer 기반 판단 (좌측 페이지 우선)

```python
# backend/structure/content_boundary_detector.py
def detect_boundaries(self, parsed_data):
    # Footer 요소 분석 (좌측 페이지 우선)
    # 본문/서문/종문 경계 탐지
    # Footer 패턴 기반 판단
```

**구현 특징**:
- Footer 요소를 우선적으로 분석
- 좌측 페이지(홀수 페이지)의 Footer를 우선 판단 기준으로 사용
- 키워드 기반 탐지보다 Footer 패턴 기반 판단

### ChapterDetector

**핵심 원칙**: Footer 기반 챕터 탐지, 숫자 기반 챕터 구분

```python
# backend/structure/chapter_detector.py
def detect_chapters(self, parsed_data, main_pages):
    # Footer 기반 챕터 탐지
    # 숫자 기반 챕터 구분 (특별한 식별자 무시)
    # 챕터 범위 계산 (start_page, end_page)
```

**구현 특징**:
- Footer 요소에서 챕터 번호 추출
- 숫자 기반으로만 챕터 구분 (예: 1, 2, 3...)
- 특별한 식별자(예: "제1장", "CHAPTER 1")는 무시하고 숫자만 사용

## 텍스트 정리 모듈

### TextOrganizer

구조 분석 완료 후 본문 텍스트만 정리하여 JSON 파일 생성

```python
# backend/structure/text_organizer.py
def organize_text(self, book_id, structure_data, pdf_path, book_title):
    # 구조 분석 결과 기반으로 본문 텍스트만 추출
    # JSON 파일로 저장 (data/output/text/{book_title}_simple.json)
    # 챕터별 페이지 텍스트 구조화
```

## 구조 후보 API

```python
# GET /api/books/{id}/structure/candidates
{
    "meta": {"total_pages": 100, ...},
    "auto_candidates": [
        {"label": "heuristic_v1", "structure": {...}},
        {"label": "llm_v2", "structure": {...}}
    ],
    "chapter_title_candidates": [...],
    "samples": {"head": [...], "tail": [...], "around_main_start": [...]}
}
```

## 최종 구조 확정 API

```python
# POST /api/books/{id}/structure/final
class FinalStructureInput(BaseModel):
    main_start_page: int
    main_end_page: Optional[int] = None
    chapters: List[FinalChapterInput]
    notes_pages: List[int] = []
    start_pages: List[int] = []
    end_pages: List[int] = []
```

## 핵심 원칙

1. **Footer 기반 판단 (좌측 페이지 우선)**
   - Footer 요소를 우선적으로 분석
   - 좌측 페이지(홀수 페이지)의 Footer를 우선 판단 기준으로 사용

2. **숫자 기반 챕터 구분**
   - 특별한 식별자(예: "제1장", "CHAPTER 1")는 무시
   - 숫자만 사용하여 챕터 구분 (예: 1, 2, 3...)

3. **LLM 보정 제외**
   - 휴리스틱만 사용
   - LLMStructureRefiner는 사용하지 않음

## 체크리스트

- [ ] Footer 기반 경계 탐지 구현 (좌측 페이지 우선)
- [ ] Footer 기반 챕터 탐지 구현 (숫자 기반)
- [ ] 숫자만 사용하여 챕터 구분 (특별한 식별자 무시)
- [ ] 본문 텍스트 정리 모듈 구현 (JSON 파일 생성)
- [ ] LLM 보정 사용 금지 (휴리스틱만 사용)

## 참고

- `docs/core_logics.md`: 상세 설계 문서
- Phase 3 완료 내용: `TODOs.md` (Line 83-102)
