# 87권 완벽 처리 개선 계획

## 목표
87권의 책이 모두 파싱, 구조 분석, 텍스트 생성이 완료될 때까지 개선

## 현재 상태
- 전체 책: 87권
- 구조 분석 완료: 84권 (96.6%)
- 텍스트 파일: 83개
- 문제: 일부 책에서 파싱/구조/텍스트 단계 중 하나 이상 실패

## 문제 분류

### 1. 파싱 불완전한 도서
**진단 기준:**
- DB status가 `UPLOADED` (파싱 시작 안 됨)
- DB status가 `ERROR_PARSING` (파싱 실패)
- DB status가 `PARSED`이지만 `page_count`가 0이거나 비정상적
- **파싱 완료되었지만 모든 페이지가 제대로 파싱되지 않음**
  - DB의 `page_count`와 실제 파싱된 페이지 수 불일치
  - 캐시 파일의 페이지 데이터 누락
  - Pages 테이블의 실제 레코드 수와 `page_count` 불일치

**확인 방법:**
- DB에서 status 확인
- 캐시 파일 존재 여부 확인
- DB의 `page_count` 값 확인
- **캐시 파일에서 실제 파싱된 페이지 수 확인** (elements를 페이지별로 그룹화)
- **Pages 테이블의 실제 레코드 수 확인** (book_id별)
- **페이지 번호 연속성 확인** (1, 2, 3, ... 순서대로 있는지)
- **각 페이지의 raw_text가 비어있지 않은지 확인**

### 2. 파싱 완료했지만 구조 분석 실패
**진단 기준:**
- DB status가 `PARSED` (구조 분석 시작 안 됨)
- DB status가 `ERROR_STRUCTURING` (구조 분석 실패)
- 구조 파일(`*_structure.json`)이 없음

**확인 방법:**
- DB status 확인
- 구조 파일 존재 여부 확인
- 구조 분석 로그 확인

### 3. 구조 분석 완료했지만 텍스트 생성 실패
**진단 기준:**
- DB status가 `STRUCTURED` (텍스트 생성 시작 안 됨)
- 텍스트 파일(`*_text.json`)이 없음
- 텍스트 파일 생성 로그에 에러 있음

**확인 방법:**
- DB status 확인
- 텍스트 파일 존재 여부 확인 (해시 기반 파일명 매칭)
- 텍스트 생성 로그 확인

## 개선 단계

### Phase 1: 진단 스크립트 작성 및 실행
**목표:** 3가지 문제 유형별로 문제가 있는 책 목록 정확히 파악

**작업:**
1. `diagnose_processing_issues.py` 스크립트 작성
   - 파싱 불완전한 책 목록 추출
     - Status 기반 확인 (UPLOADED, ERROR_PARSING)
     - page_count 비정상 확인 (0이거나 None)
     - **페이지 파싱 완전성 검증**
       - 캐시 파일에서 실제 파싱된 페이지 수 확인
       - Pages 테이블 레코드 수 확인
       - 페이지 번호 연속성 확인 (1부터 연속적으로 있는지)
       - 각 페이지의 raw_text 비어있지 않은지 확인
   - 구조 분석 실패한 책 목록 추출
   - 텍스트 생성 실패한 책 목록 추출
   - 각 책의 상세 상태 출력

**출력:**
- 문제 유형별 책 목록 (ID, 제목, 현재 상태, 에러 원인)
- **파싱 완전성 검증 결과** (예상 페이지 수 vs 실제 파싱된 페이지 수)
- 전체 통계 (각 문제 유형별 개수)

### Phase 2: 파싱 문제 해결
**목표:** 파싱 불완전한 모든 책을 파싱 완료 상태로 만들기

**작업:**
1. 파싱 실패한 책 재파싱
   - `UPLOADED` 상태 책 → 파싱 실행
   - `ERROR_PARSING` 상태 책 → 에러 로그 확인 후 재파싱
   - `PARSED`이지만 비정상적인 책 → 재파싱

2. 에러 원인 분석 및 해결
   - Upstage API 실패 → 재시도 로직 확인
   - 파일 경로 문제 → 경로 수정
   - 기타 에러 → 로그 분석 후 해결

**검증:**
- 모든 책이 `PARSED` 상태가 되었는지 확인
- page_count가 정상인지 확인
- **모든 페이지가 제대로 파싱되었는지 확인**
  - 캐시 파일의 페이지 수와 DB page_count 일치
  - Pages 테이블의 레코드 수와 page_count 일치
  - 페이지 번호가 1부터 연속적으로 존재
  - 각 페이지의 raw_text가 비어있지 않음

### Phase 3: 구조 분석 문제 해결
**목표:** 파싱 완료한 모든 책을 구조 분석 완료 상태로 만들기

**작업:**
1. 구조 분석 실패한 책 재구조 분석
   - `PARSED` 상태 책 → 구조 분석 실행
   - `ERROR_STRUCTURING` 상태 책 → 에러 로그 확인 후 재구조 분석

2. 구조 분석 로직 개선 (필요시)
   - 휴리스틱 로직 실패 케이스 분석
   - 특수 케이스 처리 추가

**검증:**
- 모든 책이 `STRUCTURED` 상태가 되었는지 확인
- 구조 파일이 모두 생성되었는지 확인

### Phase 4: 텍스트 생성 문제 해결
**목표:** 구조 분석 완료한 모든 책의 텍스트 파일 생성

**작업:**
1. 텍스트 생성 실패한 책 재생성
   - `STRUCTURED` 상태이지만 텍스트 파일 없는 책 → 텍스트 생성 실행
   - 텍스트 생성 에러 로그 확인 후 재생성

2. 텍스트 생성 로직 개선 (필요시)
   - 파일명 매칭 문제 해결
   - 구조 데이터 누락 케이스 처리

**검증:**
- 모든 책에 텍스트 파일이 생성되었는지 확인
- 텍스트 파일 내용이 정상인지 확인

### Phase 5: 최종 검증
**목표:** 87권 모두 완료 상태 확인

**작업:**
1. 전체 상태 검증 스크립트 실행
   - 모든 책이 `STRUCTURED` 상태인지 확인
   - 모든 책에 텍스트 파일이 있는지 확인
   - 파일과 DB 상태 일치 확인

2. 문제가 남아있으면 Phase 2-4 반복

## 실행 순서

1. **진단 스크립트 작성 및 실행** → 문제 목록 파악
2. **파싱 문제 해결** → 모든 책 파싱 완료
3. **구조 분석 문제 해결** → 모든 책 구조 분석 완료
4. **텍스트 생성 문제 해결** → 모든 책 텍스트 파일 생성
5. **최종 검증** → 87권 모두 완료 확인

## 예상 결과

- 전체 87권 모두 `STRUCTURED` 상태
- 텍스트 파일 87개 모두 생성
- 구조 파일 87개 모두 생성
- 캐시 파일 87개 모두 생성

## 주의사항

- 각 Phase 완료 후 검증 필수
- 에러 로그를 자세히 분석하여 근본 원인 파악
- 재시도 시 기존 데이터 손실 방지
- 병렬 처리 시 SQLite 동시 쓰기 문제 주의

