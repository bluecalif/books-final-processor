# E2E 테스트 실행 계획

## 사전 확인 사항

### 1. 캐싱 디렉토리 상태
- **위치**: `data/cache/upstage/`
- **상태**: 디렉토리 존재, 캐시 파일 0개 (깨끗한 상태)
- **의미**: 첫 번째 테스트는 캐시 미스, 두 번째 테스트는 캐시 히트 예상

### 2. 테스트 PDF 파일
- **1단계 테스트**: `data/input/1등의 통찰_10p.pdf` (10페이지)
- **2단계 테스트**: `data/input/1등의 통찰.pdf` (전체 페이지)
- **현재 상태**: 파일 없음 (사용자가 직접 넣을 예정)

## 테스트 실행 순서

### 1단계: 10페이지 PDF 테스트 (`1등의 통찰_10p.pdf`)

**목적**: 빠른 검증 (10페이지이므로 파싱 시간 단축)

**검증 항목**:
1. PDF 파일 업로드 성공
2. 백그라운드 작업 완료 (uploaded → parsed)
3. 파싱 결과 검증 (page_count > 0)
4. 캐시 저장 검증 (캐시 파일 생성 확인)
5. 양면 분리 검증 (page_count >= 10)
6. 페이지 데이터 검증 (선택적)

**예상 결과**:
- 원본 10페이지 → 양면 분리 후 20페이지 예상
- 캐시 파일 생성: `data/cache/upstage/{file_hash}.json`

### 2단계: 전체 PDF 테스트 (`1등의 통찰.pdf`)

**목적**: 최종 검증 (전체 페이지로 전체 플로우 확인)

**검증 항목**: 1단계와 동일

**예상 결과**:
- 전체 페이지 수 확인
- 캐시 파일 생성 확인

## 로그 파일 위치

### 테스트 실행 시 생성되는 로그
1. **서버 로그**: `data/test_results/server_{timestamp}.log`
2. **테스트 로그**: `data/test_results/cache_analysis_{timestamp}.log` (일부 테스트만)

### 로그 확인 순서 (실패 시)
1. 테스트 로그 파일 확인 (테스트 실행 흐름)
2. 서버 로그 파일 확인 (백엔드 서비스 실행 흐름)
3. 캐시 파일 확인 (`data/cache/upstage/`)

## 실행 명령어

```powershell
# E2E 테스트 실행 (마커 사용)
poetry run pytest -m e2e backend/tests/test_e2e_pdf_parsing.py -v

# 특정 테스트만 실행
poetry run pytest -m e2e backend/tests/test_e2e_pdf_parsing.py::test_e2e_pdf_parsing_full_flow -v
```

## 체크포인트 요약

### 필수 체크포인트 (8개)
1. PDF 파일 존재 확인
2. PDF 파일 업로드 성공
3. 업로드된 책 상태 확인 (uploaded)
4. 백그라운드 작업 완료 대기 (uploaded → parsed)
5. 파싱 결과 검증 (status == "parsed", page_count > 0)
6. 캐시 저장 검증 (캐시 파일 생성 및 내용 확인)
7. 양면 분리 검증 (page_count >= 원본 페이지 수)
8. 페이지 데이터 검증 (선택적, API 존재 시)

## 예상 실행 시간

- **1단계 (10페이지)**: 약 1-2분 (Upstage API 호출 시간 포함)
- **2단계 (전체 페이지)**: 약 5-10분 (페이지 수에 따라 다름)

## 문제 발생 시 확인 사항

1. **타임아웃**: 백그라운드 작업이 5분 이상 걸림
   - 확인: 서버 로그 파일에서 파싱 진행 상황 확인
   - 원인: Upstage API 응답 지연, 네트워크 문제

2. **캐시 저장 실패**: 캐시 파일이 생성되지 않음
   - 확인: 서버 로그 파일에서 `[CACHE_SAVE]` 로그 확인
   - 원인: 파일 시스템 권한 문제, 디스크 공간 부족

3. **양면 분리 실패**: 페이지 수가 예상과 다름
   - 확인: 서버 로그 파일에서 `[INFO] Parsing completed: ...` 로그 확인
   - 원인: 양면 분리 로직 오류

